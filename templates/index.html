<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GroupUs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>    
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <style>
      #calculator-wrapper {
        display: none;
      }
      .prefs-list {
        padding-bottom: 4rem;
        position: relative;

      }
      .prefs-list::after{
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        text-align: center; 
        font-size: 2rem;
        content: "+";
      }
      .active {
        pointer-events: none;
      }
    </style>
  </head>
  <body>
  <form>
    <div class="container">
      <h1 class="text-center">Group us!</h1>

      <div class="card mb-2">
      
        <div class="d-flex">
          <div class="p-2 w-100">
            <input required 
              class="text-center form-control p-4 fw-bold" 
              type="text" 
              id="inputField" 
              oninput="convertToElements()" 
              placeholder="Add names, comma separated..." 
              autocomplete="off"
            >
          </div>
          <div class="p-2 flex-shrink-1">
            <input required 
              class="text-center form-control p-4 fw-bold" 
              type="number" 
              name="group_size" 
              id="group_size" 
              step="1" 
              placeholder="Group size" 
              autocomplete="off"
            >
          </div>
          <textarea type="text" name="personsPrefs" id="personsPrefs" hidden></textarea>
        </div>

      </div>

      <div id="calculator-wrapper" class="text-center card  mb-2">

          <h2>
            You all
          </h2>
          <div id="personsContainer" class="list-group list-group-horizontal mb-4 justify-content-center flex-wrap p-2">
          </div>

          <h2>
              Drag and drop your preferences
          </h2>
          <div id="prefsContainer" class="flex-wrap d-flex justify-content-center">
          </div>

          <div class="p-2">
            <span 
              class="btn btn-success fw-bold" 
              id="btn-generate-groups"
              hx-post="/calculate" hx-trigger="click" hx-target="#groups-result"
            >
              Generate groups
            </span>
          </div>

          <div class="m-2 alert alert-success" id="groups-result">
          </div>

      </div>
  </div>
    
</form>


  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script> -->

  <script>

const calculatorWrapperElement = document.getElementById('calculator-wrapper');
const prefsParentElement = document.getElementById('prefsContainer');
const personsParentElement = document.getElementById('personsContainer');
const personsPrefsFormElement = document.getElementById('btn-generate-groups');
const personsPrefsInputElement = document.getElementById('personsPrefs');

personsPrefsFormElement.addEventListener('click', getPersonPrefs);

const personsObj = new Set();

new Sortable(personsContainer, {
    group: {
      name: "shared",
        pull: 'clone',
        put: false,
    },
    sort: false,
    animation: 150
});

function getPersonPrefs(){
  console.log('Executing before form submission...');
  const personsPrefsObjs = []

  for (personPref of prefsParentElement.children) {
      const dataAttributeValues = [];
      const listItems = personPref.querySelectorAll('.list-group-item');

      listItems.forEach(item => {
        const dataAttributeValue = item.getAttribute('data-id');
        dataAttributeValues.push(dataAttributeValue);
      });
      personsPrefsObjs.push(dataAttributeValues)
  }

  // console.info("personsPrefsObjs: ", personsPrefsObjs)
  personsPrefsInputElement.value = JSON.stringify(personsPrefsObjs);
};


function convertToElements() {
    const inputField = document.getElementById("inputField");
    const inputValues = inputField.value.split(",");

    inputValues.forEach(function(value) {
        value = value.trim();
        // console.log(inputField.value)

        if (inputField.value.endsWith(",")){         
          if (value) {
            // console.info(value);
            personsObj.add(value);
            // console.log(personsObj);
            buildPrefsTable(personsObj);
          };
        };
        
    });
}


function buildPrefsTable(personsObj) {
  calculatorWrapperElement.style.display = "block"; 
  personsParentElement.replaceChildren();
  prefsParentElement.replaceChildren();

  for (person of personsObj) {
    const personElement = `<div class="text-nowrap list-group-item" data-id="${person}">${person}</div>`;
    personsParentElement.insertAdjacentHTML("beforeend", personElement);

  const prefsContainer = `<div class="card m-4">
   <div id="prefs-${person}" class="prefs-list list-group list-group-flush">
    <div 
      class="list-group-item text-nowrap active" 
      data-id="${person}"
    >${person}</div>
  </div>
  </div>`;


  prefsParentElement.insertAdjacentHTML("beforeend", prefsContainer);

  const prefsSortable = document.getElementById(`prefs-${person}`);
  const sortable = Sortable.create(prefsSortable, {
    animation: 150,
    group: {
      name: "shared",
      pull: 'clone',
        sort: true,
        put: (to, from, dragEl, event) => { for (let i = 0; i < to.el.children.length; i++) { if (to.el.children[i].getAttribute("data-id") === dragEl.getAttribute("data-id")) { console.log("already exist"); return false } } return true }
    },
  });
  };
};


    </script>

  </body>
</html>
